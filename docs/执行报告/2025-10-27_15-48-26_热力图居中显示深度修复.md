# 热力图股票数据居中显示深度修复报告

## 问题现状

用户反馈：第一次修复后，股票名称、股价、涨跌幅的居中显示问题依然存在，需要进行更深入的修复。

## 深度分析

### 1. 问题根源再识别

经过更深入的分析，发现之前修复存在的不足：

**第一次修复的问题**:
1. **过度复杂的富文本配置**: 使用了复杂的 `rich` 对象配置，导致 ECharts 无法正确应用居中样式
2. **配置冲突**: 同时在 label 级别和 rich 级别设置对齐属性，造成冲突
3. **空间不足**: `upperLabel` 占用过多垂直空间，压缩股票方块的显示区域
4. **最小可见面积过小**: `visibleMin: 1` 导致过小的方块无法正确显示文本

### 2. 核心技术问题

ECharts treemap 的标签居中机制：
- `align` 和 `verticalAlign` 是容器级别的对齐
- `position: 'inside'` 是标签位置控制
- 富文本（rich）配置可能会干扰基本的居中机制
- `upperLabel` 会占用额外的垂直空间

## 修复方案 v2.0

### 1. 简化标签配置

**完全重写 label 配置**:
```typescript
label: {
  show: true,
  position: 'inside',  // 关键：明确指定在内部
  fontSize: 11,
  fontWeight: 'bold',
  color: '#fff',
  align: 'center',     // 水平居中
  verticalAlign: 'middle', // 垂直居中
  padding: [4, 6, 4, 6],  // 控制内边距
  formatter: function (params: any) {
    const stock = params.data?.stockData;
    if (!stock) return '';
    const sign = stock.changePercent >= 0 ? '+' : '';

    // 简化的多行文本
    const lines = [
      stock.symbol,
      `$${stock.last.toFixed(2)}`,
      `${sign}${stock.changePercent.toFixed(2)}%`
    ];
    return lines.join('\n');
  },
  rich: {},  // 清空富文本配置，使用默认样式
  overflow: 'truncate',
  ellipsis: '...',
}
```

### 2. 调整 treemap 布局参数

```typescript
squareRatio: 0.5,        // 保持方形布局
visibleMin: 50,          // 提高最小可见面积，确保文本空间
childrenVisibleMin: 25,  // 子节点最小可见面积
```

### 3. 释放显示空间

**隐藏 upperLabel**:
```typescript
upperLabel: {
  show: false,  // 隐藏，给股票方块更多空间
  height: 16,
  // ... 其他配置
}
```

## 修改详情

### 文件修改列表

| 文件路径 | 行号范围 | 修改内容 |
|---------|----------|----------|
| `components/heatmap/UserHeatmap.tsx` | 597-627 | 完全重写 label 配置，简化居中逻辑 |
| `components/heatmap/UserHeatmap.tsx` | 581-584 | 调整 treemap 布局参数 |
| `components/heatmap/UserHeatmap.tsx` | 628-641 | 隐藏 upperLabel 释放空间 |

### 关键修改点

1. **添加 `position: 'inside'`**: 明确指定标签在方块内部显示
2. **移除 rich 富文本配置**: 使用默认样式，避免配置冲突
3. **调整 padding**: 从 `[5, 8, 5, 8]` 改为 `[4, 6, 4, 6]`，节省空间
4. **提升 visibleMin**: 从 1 提升到 50，确保足够的显示空间
5. **隐藏 upperLabel**: 从 `show: true` 改为 `show: false`

## 技术原理

### ECharts Treemap 标签居中的正确方式

1. **位置指定**: `position: 'inside'` 确保标签在方块内部
2. **对齐属性**: `align: 'center'` 和 `verticalAlign: 'middle'` 控制容器对齐
3. **多行文本**: 使用 `\n` 换行，ECharts 自动处理居中
4. **避免富文本**: 复杂的 rich 配置可能会干扰基本的居中机制
5. **空间管理**: 确保方块有足够的最小尺寸显示文本

### 布局优化原理

- **方形比例**: `squareRatio: 0.5` 确保方块接近正方形，有利于文本居中
- **最小面积**: `visibleMin: 50` 确保小方块也有足够空间显示文本
- **释放空间**: 隐藏 `upperLabel` 给股票方块更多垂直空间

## 预期效果

1. **完美居中**: 股票名称、股价、涨跌幅在方块中完全居中显示
2. **清晰可读**: 适当的内边距和字体大小确保文本清晰
3. **响应式布局**: 股票方块大小自适应，但文本始终居中
4. **空间优化**: 隐藏不必要的标签，最大化显示区域

## 测试验证

### 测试步骤

1. 启动开发服务器:
   ```bash
   npm run dev
   ```

2. 访问热力图页面:
   ```
   http://localhost:3100/heatmap
   ```

3. 验证以下场景:
   - ✅ 大股票方块中的文本是否完全居中
   - ✅ 小股票方块中的文本是否正确显示且居中
   - ✅ 不同股票名称长度是否都能正确显示
   - ✅ 股价和涨跌幅是否在股票名称下方居中显示
   - ✅ Pool 分组是否仍有清晰的边界

### 视觉检查点

- 股票名称（第一行）应完全水平居中
- 股价（第二行）应完全水平居中
- 涨跌幅（第三行）应完全水平居中
- 三行文本整体应垂直居中
- 文本不应贴边，应有适当边距

## 总结

本次深度修复彻底重构了热力图的标签显示逻辑，采用更符合 ECharts treemap 设计理念的配置方式。通过简化配置、明确指定位置参数、优化布局空间，确保股票名称、股价、涨跌幅能够完美居中显示。

核心改进：
- ✅ 使用 `position: 'inside'` 明确标签位置
- ✅ 简化配置，避免富文本冲突
- ✅ 优化空间分配，提升显示质量
- ✅ 调整最小尺寸，确保小方块也能正确显示

---

**修复时间**: 2025-10-27 15-48-26
**修复版本**: v2.0 深度修复
**修复状态**: ✅ 已完成
**预期效果**: 完美居中显示
**测试状态**: 待验证
