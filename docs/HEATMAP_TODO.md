# ğŸ”„ çƒ­åŠ›å›¾å¾…ä¼˜åŒ–é¡¹ç›®æ¸…å•

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-25  
**æœ€åæ›´æ–°**ï¼š2025-10-25  
**ç»„ä»¶**ï¼š`components/heatmap/UserHeatmap.tsx`

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### é«˜ä¼˜å…ˆçº§ï¼ˆå…³é”®æ€§èƒ½ï¼‰
- [x] ç²¾å‡†çŠ¶æ€æ›´æ–°ï¼ˆå¯¹è±¡å…‹éš†å‡å°‘ 98%ï¼‰
- [x] ECharts å®ä¾‹ç”Ÿå‘½å‘¨æœŸä¼˜åŒ–ï¼ˆæ¶ˆé™¤å†…å­˜æ³„æ¼ï¼‰
- [x] ECharts é…ç½®ä¼˜åŒ–ï¼ˆlazyUpdate + notMergeï¼‰

### ä¸­ä¼˜å…ˆçº§ï¼ˆå¥å£®æ€§ï¼‰
- [x] SSE å¥å£®é‡è¿æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ã€è¶…æ—¶ã€å¿ƒè·³ï¼‰
- [x] SSE æ›´æ–°èŠ‚æµï¼ˆrequestAnimationFrame æ‰¹é‡å¤„ç†ï¼‰
- [x] MongoDB å¸‚å€¼ç¼“å­˜å±‚ï¼ˆå‡å°‘ 90% API è°ƒç”¨ï¼‰
- [x] Inngest å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©è‡ªåŠ¨æ›´æ–°å¸‚å€¼ï¼‰

### æ˜¾ç¤ºä¼˜åŒ–
- [x] ä¸€çº§è§†å›¾æ˜¾ç¤ºæ‰€æœ‰ Pool çš„è‚¡ç¥¨ï¼ˆleafDepth: 2ï¼‰
- [x] å¸‚å€¼æ•°æ®å›é€€æœºåˆ¶ï¼ˆå¤„ç†æ— æ•ˆæ•°æ®ï¼‰
- [x] å¹³æ»‘ç®—æ³•ï¼ˆå¯¹æ•° â†’ å¹³æ–¹æ ¹ï¼‰
- [x] æ™ºèƒ½ label æ˜¾ç¤ºç­–ç•¥ï¼ˆæ ¹æ®æ–¹å—å¤§å°ï¼‰

---

## ğŸ”„ å¾…ä¼˜åŒ–é¡¹ç›®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼šæ˜¾ç¤ºæ•ˆæœè°ƒæ•´

#### 1. **å¹³æ»‘ç®—æ³•å¾®è°ƒ**
**é—®é¢˜**ï¼šå½“å‰å¹³æ–¹æ ¹å¹³æ»‘å¯èƒ½ä»éœ€è°ƒæ•´å¹³è¡¡ç‚¹

**å¯é€‰æ–¹æ¡ˆ**ï¼š
```typescript
// æ–¹æ¡ˆ Aï¼šç«‹æ–¹æ ¹ï¼ˆæ›´æ¸©å’Œï¼‰
return Math.cbrt(marketCap);

// æ–¹æ¡ˆ Bï¼šè°ƒæ•´çš„å¹³æ–¹æ ¹ï¼ˆå¯è°ƒèŠ‚ç³»æ•°ï¼‰
const coefficient = 0.7; // 0.5-1.0 å¯è°ƒ
return Math.pow(marketCap, coefficient);

// æ–¹æ¡ˆ Cï¼šåˆ†æ®µå¹³æ»‘ï¼ˆå¤§è‚¡ç¥¨ç”¨å¹³æ–¹æ ¹ï¼Œå°è‚¡ç¥¨ç”¨çº¿æ€§ï¼‰
if (marketCap > 1000000000000) { // > 1T
  return Math.sqrt(marketCap);
} else {
  return marketCap / 100000; // çº¿æ€§ç¼©æ”¾
}

// æ–¹æ¡ˆ Dï¼šå¯¹æ•°-çº¿æ€§æ··åˆ
const alpha = 0.5; // æ··åˆæ¯”ä¾‹
return alpha * Math.log(marketCap) + (1 - alpha) * (marketCap / 1000000000);
```

---

#### 2. **Label æ˜¾ç¤ºä¼˜åŒ–**
**é—®é¢˜**ï¼šå½“å‰åŸºäºé¢ç§¯çš„é˜ˆå€¼å¯èƒ½ä¸å¤Ÿç²¾ç¡®

**æ”¹è¿›æ–¹å‘**ï¼š
```typescript
// è€ƒè™‘å®½é«˜æ¯”ï¼Œé¿å…ç»†é•¿æ–¹å—æ˜¾ç¤ºè¿‡å¤šæ–‡å­—
const width = params.rect?.width || 0;
const height = params.rect?.height || 0;
const aspectRatio = Math.max(width, height) / Math.min(width, height);

if (area > 1500 && aspectRatio < 3) {
  // åªæœ‰æ¯”è¾ƒæ–¹æ­£çš„å¤§æ–¹å—æ‰æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
  return [symbol, price, change].join('\n');
} else if (width > 40 && height > 25) {
  // å®½é«˜éƒ½è¶³å¤Ÿæ‰æ˜¾ç¤º
  return [symbol, change].join('\n');
}
```

---

#### 3. **åŠ¨æ€å­—ä½“å¤§å°**
**é—®é¢˜**ï¼šå›ºå®šå­—ä½“å¯èƒ½ä¸é€‚åˆæ‰€æœ‰æ–¹å—

**æ”¹è¿›æ–¹å‘**ï¼š
```typescript
// æ ¹æ®æ–¹å—å¤§å°åŠ¨æ€è°ƒæ•´å­—ä½“
const fontSize = Math.max(8, Math.min(14, Math.sqrt(area) / 3));

return {
  symbol: stock.symbol,
  fontSize: fontSize,
  // ...
};
```

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼šäº¤äº’ä½“éªŒ

#### 4. **æ·»åŠ ç¼©æ”¾åŠŸèƒ½**
**ç›®çš„**ï¼šè®©ç”¨æˆ·å¯ä»¥æ”¾å¤§æŸ¥çœ‹å°è‚¡ç¥¨

**å®ç°**ï¼š
```typescript
roam: 'move', // å…è®¸æ‹–åŠ¨å’Œç¼©æ”¾
scaleLimit: {
  min: 1,
  max: 5,
},
```

---

#### 5. **é”®ç›˜å¯¼èˆªæ”¯æŒ**
**ç›®çš„**ï¼šæå‡æ— éšœç¢æ€§

**å®ç°**ï¼š
- æ–¹å‘é”®åˆ‡æ¢é€‰ä¸­çš„è‚¡ç¥¨
- Enter é”®è¿›å…¥è¯¦æƒ…
- Escape é”®è¿”å›ä¸Šå±‚

---

#### 6. **è‡ªå®šä¹‰é…ç½®é¢æ¿**
**åŠŸèƒ½**ï¼š
- é€‰æ‹©å¹³æ»‘ç®—æ³•ï¼ˆçº¿æ€§/å¹³æ–¹æ ¹/å¯¹æ•°ï¼‰
- è°ƒæ•´ label æ˜¾ç¤ºè¯¦ç»†ç¨‹åº¦
- åˆ‡æ¢é¢œè‰²ä¸»é¢˜

---

### ğŸ”µ ä½ä¼˜å…ˆçº§ï¼šä»£ç è´¨é‡

#### 7. **ç»„ä»¶æ‹†åˆ†**
å½“å‰ 650+ è¡Œå•æ–‡ä»¶ï¼Œå»ºè®®æ‹†åˆ†ä¸ºï¼š
- `hooks/useHeatmapData.ts` - æ•°æ®è·å– + SSE
- `hooks/useHeatmapChart.ts` - ECharts ç®¡ç†
- `utils/heatmap-config.ts` - é…ç½®å’Œå¸¸é‡
- `utils/heatmap-smoothing.ts` - å¹³æ»‘ç®—æ³•
- å­ç»„ä»¶ï¼ˆToolbarã€Legend ç­‰ï¼‰

---

#### 8. **ç±»å‹å®‰å…¨å¢å¼º**
```typescript
import type { ECElementEvent } from 'echarts/types/dist/echarts';

// æ›¿æ¢æ‰€æœ‰ any
chart.on('click', function (params: ECElementEvent) { ... });
```

---

#### 9. **å•å…ƒæµ‹è¯•**
```typescript
// __tests__/heatmap.test.tsx
describe('smoothValue', () => {
  it('should handle zero marketCap', () => {
    expect(smoothValue(0)).toBe(1);
  });
  
  it('should compress extreme values', () => {
    const large = 3000000000000; // 3T
    const small = 100000000000;  // 100B
    const ratio = smoothValue(large) / smoothValue(small);
    expect(ratio).toBeGreaterThan(3);
    expect(ratio).toBeLessThan(10);
  });
});
```

---

## ğŸ’¡ å·²çŸ¥é—®é¢˜å’Œè§£å†³æ€è·¯

### Issue 1: è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºä¸å…¨
**çŠ¶æ€**ï¼šğŸŸ¡ å¾…ä¼˜åŒ–  
**åŸå› **ï¼šå¹³æ»‘ç®—æ³•å’Œ label ç­–ç•¥éœ€è¦è¿›ä¸€æ­¥å¹³è¡¡  
**å»ºè®®æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆé€‰æ‹©å¹³æ»‘å¼ºåº¦ï¼‰
2. å®ç°åŠ¨æ€å­—ä½“å¤§å°
3. è€ƒè™‘å®½é«˜æ¯”ï¼Œé¿å…ç»†é•¿æ–¹å—æ˜¾ç¤ºè¿‡å¤šæ–‡å­—

---

### Issue 2: Finnhub å¸‚å€¼æ•°æ®ä¸å®Œæ•´
**çŠ¶æ€**ï¼šâœ… å·²ç¼“è§£ï¼ˆå›é€€æœºåˆ¶ï¼‰  
**é•¿æœŸæ–¹æ¡ˆ**ï¼š
1. å‡çº§åˆ° Finnhub ä»˜è´¹è´¦å·
2. åˆ‡æ¢åˆ° IEX Cloud æˆ– Alpha Vantage
3. å®ç°å¤šæ•°æ®æºå›é€€ç­–ç•¥

---

### Issue 3: å®æ—¶æ›´æ–°å¯èƒ½è§¦å‘æ— é™å¾ªç¯
**çŠ¶æ€**ï¼šâš ï¸ æ½œåœ¨é£é™©ï¼ˆæœªè§‚å¯Ÿåˆ°ï¼‰  
**ç›‘æ§**ï¼šå¦‚æœ SSE è¿æ¥å CPU æŒç»­é«˜ä½¿ç”¨ç‡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ï¼š
- SSE æ¶ˆæ¯è§¦å‘çŠ¶æ€æ›´æ–°
- çŠ¶æ€æ›´æ–°è§¦å‘ useEffect
- useEffect è§¦å‘ SSE é‡è¿
- å½¢æˆå¾ªç¯

**è§£å†³**ï¼šæ·»åŠ ä¾èµ–è¿½è¸ªå’Œé˜²æŠ–

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å¤©ï¼‰
1. ç»§ç»­è°ƒè¯• label æ˜¾ç¤ºç­–ç•¥
2. æ·»åŠ ç”¨æˆ·é…ç½®é¢æ¿ï¼ˆé€‰æ‹©å¹³æ»‘ç®—æ³•ï¼‰
3. æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•

### ä¸­æœŸï¼ˆ1-2 å‘¨ï¼‰
1. ç»„ä»¶æ‹†åˆ†å’Œä»£ç é‡æ„
2. æ·»åŠ å•å…ƒæµ‹è¯•
3. ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ

### é•¿æœŸï¼ˆ1 ä¸ªæœˆ+ï¼‰
1. åˆ‡æ¢åˆ°æ›´å¥½çš„æ•°æ®æº
2. æ·»åŠ æ›´å¤šå›¾è¡¨ç±»å‹ï¼ˆæ ‘çŠ¶å›¾ã€æ°”æ³¡å›¾ï¼‰
3. å®ç°è‡ªå®šä¹‰é…ç½®å’Œä¸»é¢˜

---

## ğŸ“ å‚è€ƒèµ„æ–™

### å¹³æ»‘ç®—æ³•æ–‡çŒ®
- [Finviz Heatmap](https://finviz.com/map.ashx) - å‚è€ƒå®ç°
- [TradingView Heatmap](https://www.tradingview.com/heatmap/stock/) - è§†è§‰è®¾è®¡
- [D3 Treemap](https://d3-wiki.readthedocs.io/zh-cn/master/Treemap-Layout/) - ç®—æ³•åŸç†

### ECharts æ–‡æ¡£
- [Treemap Configuration](https://echarts.apache.org/en/option.html#series-treemap)
- [Label Formatter](https://echarts.apache.org/en/option.html#series-treemap.label.formatter)
- [Performance Optimization](https://echarts.apache.org/handbook/en/best-practices/canvas-vs-svg/)

---

**ä¸‹æ¬¡ç»§ç»­æ—¶ï¼Œä» Issue 1 å¼€å§‹ä¼˜åŒ–ã€‚**

