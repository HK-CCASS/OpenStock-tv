# ğŸ“Š å¸‚å€¼ç¼“å­˜ç³»ç»Ÿæ–‡æ¡£

**å®ç°æ—¥æœŸ**ï¼š2025-10-25  
**ç›®çš„**ï¼šå‡å°‘ API è°ƒç”¨ã€æå‡æ€§èƒ½ã€ç¡®ä¿å¸‚å€¼æ•°æ®ç¨³å®šæ€§

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

å¸‚å€¼ç¼“å­˜ç³»ç»Ÿä½¿ç”¨ MongoDB å­˜å‚¨è‚¡ç¥¨å¸‚å€¼æ•°æ®ï¼Œæ¯å¤©è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘å¯¹ Finnhub API çš„ä¾èµ–ã€‚

### æ¶æ„å›¾
```
ç”¨æˆ·è¯·æ±‚çƒ­åŠ›å›¾
      â†“
API: /api/heatmap/user-data
      â†“
getInitialQuotes()
      â”œâ”€ getBatchStockQuotes() â†’ å®æ—¶æŠ¥ä»·ï¼ˆä»·æ ¼ã€æ¶¨è·Œå¹…ï¼‰
      â””â”€ getMarketCapCache() â†’ å¸‚å€¼æ•°æ®ï¼ˆä¼˜å…ˆç¼“å­˜ï¼‰
            â”œâ”€ æŸ¥è¯¢ MongoDB â†’ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜
            â””â”€ æœªå‘½ä¸­ â†’ Finnhub API â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›æ•°æ®

å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤© UTC 2:00ï¼‰
      â†“
updateMarketCapCache()
      â†“
æ‰¹é‡æ›´æ–°æ‰€æœ‰è§‚å¯Ÿåˆ—è¡¨è‚¡ç¥¨çš„å¸‚å€¼
```

---

## ğŸ—‚ï¸ æ•°æ®æ¨¡å‹

### MarketCap Schema

```typescript
{
  symbol: string;           // è‚¡ç¥¨ä»£ç ï¼ˆå¤§å†™ï¼Œå”¯ä¸€ï¼‰
  marketCap: number;       // å¸‚å€¼ï¼ˆç¾å…ƒï¼‰
  price: number;           // ä»·æ ¼ï¼ˆç”¨äºå›é€€è®¡ç®—ï¼‰
  source: string;          // æ•°æ®æ¥æº: finnhub | iex | fallback
  lastUpdated: Date;       // æœ€åæ›´æ–°æ—¶é—´
  validUntil: Date;        // æœ‰æ•ˆæœŸï¼ˆæ¬¡æ—¥ 00:00ï¼‰
  createdAt: Date;
  updatedAt: Date;
}
```

### ç´¢å¼•
- `{ symbol: 1 }` - å”¯ä¸€ç´¢å¼•
- `{ symbol: 1, validUntil: 1 }` - æŸ¥è¯¢æœ‰æ•ˆç¼“å­˜
- `{ validUntil: 1 }` - æ¸…ç†è¿‡æœŸæ•°æ®

---

## ğŸ”„ ç¼“å­˜ç­–ç•¥

### 1. è¯»å–æµç¨‹
```typescript
getMarketCapCache(symbols: string[])
â”œâ”€ æ­¥éª¤ 1ï¼šæŸ¥è¯¢ MongoDB æœ‰æ•ˆç¼“å­˜ï¼ˆvalidUntil > nowï¼‰
â”œâ”€ æ­¥éª¤ 2ï¼šå¡«å……å·²ç¼“å­˜çš„æ•°æ®
â”œâ”€ æ­¥éª¤ 3ï¼šæŸ¥æ‰¾ç¼ºå¤±çš„è‚¡ç¥¨ä»£ç 
â”œâ”€ æ­¥éª¤ 4ï¼šè°ƒç”¨ Finnhub API è·å–ç¼ºå¤±æ•°æ®
â”‚         â”œâ”€ å¦‚æœ marketCap æœ‰æ•ˆ â†’ source: 'finnhub'
â”‚         â””â”€ å¦‚æœ marketCap æ— æ•ˆ â†’ ä½¿ç”¨ä»·æ ¼ä¼°ç®— â†’ source: 'fallback'
â””â”€ æ­¥éª¤ 5ï¼šæ‰¹é‡æ›´æ–° MongoDBï¼ˆupsertï¼‰
```

### 2. ç¼“å­˜æœ‰æ•ˆæœŸ
- **æ—¶é•¿**ï¼šä»å½“å‰æ—¶é—´åˆ°æ¬¡æ—¥ 00:00ï¼ˆUTCï¼‰
- **åŸå› **ï¼šå¸‚å€¼æ•°æ®å˜åŒ–ç¼“æ…¢ï¼Œæ—¥å†…æ³¢åŠ¨é€šè¿‡ä»·æ ¼ä¼°ç®—
- **ä¾‹å¤–**ï¼šç¬¬äºŒå¤©å‡Œæ™¨ 2 ç‚¹å®šæ—¶ä»»åŠ¡ä¼šå¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®

### 3. å›é€€ç­–ç•¥
```
Finnhub API è¿”å›å¸‚å€¼
      â†“
å¸‚å€¼ > 0ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ç¼“å­˜æœ‰æ•ˆå¸‚å€¼ â†’ source: 'finnhub'
  â””â”€ å¦ â†’ ä»·æ ¼ Ã— 10äº¿ â†’ source: 'fallback'
            â†“
      è­¦å‘Šæ—¥å¿—ï¼šå¸‚å€¼æ— æ•ˆï¼Œä½¿ç”¨å›é€€å€¼
```

---

## â° å®šæ—¶ä»»åŠ¡

### updateMarketCapCache

**è¿è¡Œæ—¶é—´**ï¼šæ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰

**æ‰§è¡Œé€»è¾‘**ï¼š
```typescript
1. è·å–æ‰€æœ‰è§‚å¯Ÿåˆ—è¡¨çš„å”¯ä¸€è‚¡ç¥¨ä»£ç 
2. åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹ 50 ä¸ªï¼‰
3. è°ƒç”¨ getMarketCapCache() æ›´æ–°ç¼“å­˜
4. è®°å½•æˆåŠŸ/å¤±è´¥æ•°é‡
```

**æ‰‹åŠ¨è§¦å‘**ï¼ˆå¯é€‰ï¼‰ï¼š
```typescript
// åœ¨ Inngest Dashboard æˆ–é€šè¿‡ API
await inngest.send({ name: 'app/update.market.cap' });
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜å‘½ä¸­ç‡
- **é¦–æ¬¡è®¿é—®**ï¼š0%ï¼ˆéœ€è¦è°ƒç”¨ APIï¼‰
- **åç»­è®¿é—®ï¼ˆå½“å¤©ï¼‰**ï¼š~100%ï¼ˆç›´æ¥ä» MongoDB è¯»å–ï¼‰
- **æ¬¡æ—¥é¦–æ¬¡è®¿é—®**ï¼š0%ï¼ˆç¼“å­˜è¿‡æœŸï¼Œå®šæ—¶ä»»åŠ¡æ›´æ–°ï¼‰

### API è°ƒç”¨é‡å¯¹æ¯”

**ä¼˜åŒ–å‰**ï¼š
- ç”¨æˆ·æ¯æ¬¡è®¿é—®çƒ­åŠ›å›¾ â†’ è°ƒç”¨ Finnhub APIï¼ˆæ‰€æœ‰è‚¡ç¥¨ï¼‰
- 100 ç”¨æˆ·/å¤© Ã— 20 è‚¡ç¥¨ = **2000 æ¬¡ API è°ƒç”¨**

**ä¼˜åŒ–å**ï¼š
- é¦–æ¬¡è®¿é—® â†’ è°ƒç”¨ APIï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
- åç»­è®¿é—® â†’ MongoDB æŸ¥è¯¢
- å®šæ—¶ä»»åŠ¡ â†’ æ‰¹é‡æ›´æ–°
- **é¢„ä¼°ï¼š200 æ¬¡ API è°ƒç”¨/å¤©**ï¼ˆé™ä½ 90%ï¼‰

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€

**æ–¹æ³• 1ï¼šMongoDB Shell**
```javascript
// è¿æ¥åˆ°æ•°æ®åº“
mongosh mongodb://localhost:27017/openstock

// æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜
db.marketcaps.find().pretty()

// æŸ¥çœ‹ç‰¹å®šè‚¡ç¥¨
db.marketcaps.find({ symbol: "AAPL" })

// ç»Ÿè®¡ç¼“å­˜æ•°é‡
db.marketcaps.countDocuments()

// æŸ¥çœ‹è¿‡æœŸç¼“å­˜
db.marketcaps.find({ validUntil: { $lt: new Date() } })
```

**æ–¹æ³• 2ï¼šæ§åˆ¶å°æ—¥å¿—**
```
[MarketCap Cache] Fetching 15 missing symbols from API
[MarketCap Cache] SONY å¸‚å€¼æ— æ•ˆï¼Œä½¿ç”¨å›é€€å€¼: 28.65B
[MarketCap Cache] Updated 15 symbols in database
```

### æ¸…ç†è¿‡æœŸç¼“å­˜

**æ‰‹åŠ¨æ¸…ç†**ï¼ˆå¯é€‰ï¼‰ï¼š
```javascript
// åˆ é™¤è¿‡æœŸæ•°æ®
db.marketcaps.deleteMany({ validUntil: { $lt: new Date() } })
```

**è‡ªåŠ¨æ¸…ç†**ï¼ˆå»ºè®®ï¼‰ï¼š
```typescript
// åœ¨ MongoDB è®¾ç½® TTL ç´¢å¼•ï¼ˆæœªæ¥å®ç°ï¼‰
db.marketcaps.createIndex(
  { "validUntil": 1 },
  { expireAfterSeconds: 86400 }  // 24 å°æ—¶åè‡ªåŠ¨åˆ é™¤
)
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç¼“å­˜æœªç”Ÿæ•ˆ
**ç—‡çŠ¶**ï¼šæ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º "Fetching X missing symbols from API"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ MongoDB è¿æ¥ï¼š
   ```bash
   npm run test:db
   ```
2. æŸ¥çœ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼š
   ```javascript
   db.marketcaps.countDocuments()
   ```
3. æ£€æŸ¥ `validUntil` æ˜¯å¦è¿‡æœŸï¼š
   ```javascript
   db.marketcaps.find().sort({ validUntil: -1 }).limit(5)
   ```

---

### é—®é¢˜ 2ï¼šå¸‚å€¼æ•°æ®ä¸º 0
**ç—‡çŠ¶**ï¼šçƒ­åŠ›å›¾æ˜¾ç¤ºå¼‚å¸¸ï¼ŒæŸäº›è‚¡ç¥¨å æ®å·¨å¤§ç©ºé—´

**åŸå› **ï¼šFinnhub API è¿”å›çš„ `marketCapitalization` ä¸º null/0

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… å·²å®ç°å›é€€æœºåˆ¶ï¼ˆä½¿ç”¨ä»·æ ¼ä¼°ç®—ï¼‰
- âœ… å‰ç«¯ä¹Ÿæœ‰å›é€€é€»è¾‘ï¼ˆåŒé‡ä¿é™©ï¼‰

**éªŒè¯**ï¼šæŸ¥çœ‹ source å­—æ®µ
```javascript
db.marketcaps.find({ source: "fallback" })
```

---

### é—®é¢˜ 3ï¼šå®šæ—¶ä»»åŠ¡æœªè¿è¡Œ
**ç—‡çŠ¶**ï¼šæ•°æ®è¶…è¿‡ 24 å°æ—¶æœªæ›´æ–°

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥ Inngest æœåŠ¡æ˜¯å¦è¿è¡Œï¼š
   ```bash
   npx inngest-cli@latest dev
   ```
2. æŸ¥çœ‹ Inngest Dashboardï¼šhttp://localhost:8288
3. æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æµ‹è¯•ï¼š
   ```typescript
   await inngest.send({ name: 'app/update.market.cap' });
   ```

---

## ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡ï¼ˆé¢„æœŸï¼‰

### æ•°æ®é‡
- **å¹³å‡è§‚å¯Ÿåˆ—è¡¨è‚¡ç¥¨æ•°**ï¼š10-20 åª/ç”¨æˆ·
- **100 ç”¨æˆ·**ï¼š~500 æ¡ç¼“å­˜è®°å½•
- **æ¯æ¡è®°å½•å¤§å°**ï¼š~200 bytes
- **æ€»å­˜å‚¨**ï¼š~100 KBï¼ˆå‡ ä¹å¯å¿½ç•¥ï¼‰

### æ€§èƒ½æå‡
- **API è°ƒç”¨å‡å°‘**ï¼š90%
- **å“åº”æ—¶é—´**ï¼šä» ~2s â†’ ~200msï¼ˆé¦–å±åŠ è½½ï¼‰
- **ç¼“å­˜å‘½ä¸­å**ï¼š< 50msï¼ˆMongoDB æŸ¥è¯¢ï¼‰

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å¼€å‘ç¯å¢ƒ
- [x] åˆ›å»º MarketCap æ•°æ®æ¨¡å‹
- [x] å®ç° getMarketCapCache ç¼“å­˜é€»è¾‘
- [x] æ›´æ–° getInitialQuotes ä½¿ç”¨ç¼“å­˜
- [x] åˆ›å»º Inngest å®šæ—¶ä»»åŠ¡
- [ ] æµ‹è¯•ç¼“å­˜åŠŸèƒ½
- [ ] æµ‹è¯•å®šæ—¶ä»»åŠ¡

### ç”Ÿäº§ç¯å¢ƒ
- [ ] ç¡®ä¿ MongoDB è¿æ¥ç¨³å®š
- [ ] é…ç½® Inngest ç”Ÿäº§ç¯å¢ƒ
- [ ] è®¾ç½® MongoDB TTL ç´¢å¼•ï¼ˆè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼‰
- [ ] ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- [ ] è®¾ç½®å‘Šè­¦ï¼ˆç¼“å­˜å¤±æ•ˆç‡ > 20%ï¼‰

---

## ğŸ”§ é…ç½®é€‰é¡¹

### è°ƒæ•´ç¼“å­˜æœ‰æ•ˆæœŸ

**å½“å‰**ï¼šæ¬¡æ—¥ 00:00ï¼ˆUTCï¼‰

**ä¿®æ”¹æ–¹æ³•**ï¼š
```typescript
// lib/actions/heatmap.actions.ts ç¬¬ 138-140 è¡Œ
const tomorrow = new Date(now);
tomorrow.setDate(tomorrow.getDate() + 1);  // æ”¹ä¸º +2 å¯å»¶é•¿åˆ° 2 å¤©
tomorrow.setHours(0, 0, 0, 0);
```

### è°ƒæ•´å®šæ—¶ä»»åŠ¡æ—¶é—´

**å½“å‰**ï¼šæ¯å¤© UTC 02:00

**ä¿®æ”¹æ–¹æ³•**ï¼š
```typescript
// lib/inngest/functions.ts ç¬¬ 129 è¡Œ
{ cron: '0 2 * * *' }  // æ”¹ä¸º '0 10 * * *' ä¸º UTC 10:00ï¼ˆåŒ—äº¬ 18:00ï¼‰
```

### è°ƒæ•´æ‰¹å¤„ç†å¤§å°

**å½“å‰**ï¼š50 ä¸ªè‚¡ç¥¨/æ‰¹

**ä¿®æ”¹æ–¹æ³•**ï¼š
```typescript
// lib/inngest/functions.ts ç¬¬ 141 è¡Œ
const batchSize = 50;  // æ”¹ä¸º 100 å¯åŠ å¿«æ›´æ–°ï¼Œä½†å¯èƒ½è§¦å‘ API é™é€Ÿ
```

---

## ğŸ“ æœ€ä½³å®è·µ

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ `updateMarketCapCache` é¢„çƒ­ç¼“å­˜
2. **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨ "fallback" æ¯”ä¾‹ï¼Œè¿‡é«˜è¯´æ˜ Finnhub æ•°æ®è´¨é‡å·®
3. **å®šæœŸæ£€æŸ¥**ï¼šæ¯å‘¨æŸ¥çœ‹ä¸€æ¬¡ç¼“å­˜æ•°æ®å®Œæ•´æ€§
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¦‚æœç”¨æˆ·é‡å¤§ï¼Œè€ƒè™‘æ·»åŠ  Redis äºŒçº§ç¼“å­˜
5. **æ•°æ®è´¨é‡**ï¼šå¦‚æœ fallback æ¯”ä¾‹ > 30%ï¼Œè€ƒè™‘åˆ‡æ¢ API æä¾›å•†

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-25

